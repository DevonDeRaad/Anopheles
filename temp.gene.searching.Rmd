---
title: "Temperature associated genes of interest"
output:
  html_document:
    df_print: paged
---


```{r}
# package
library(ape)
library(clusterProfiler)

#bring in phase1 allele frequencies
phase1.all.freqs<-read.csv(file = "~/Desktop/anoph.3.march.2020/phase1.all.freqs.csv")
#make column for id
phase1.all.freqs$id<-paste(phase1.all.freqs$chrom,phase1.all.freqs$POS)
#bring in dataframe with locality and environmental data for each individual phase1
phase1.alldata<-read.csv(file = "~/Desktop/anoph.3.march.2020/phase1.allvariables.csv")
#subset to only the variables we need (lat,long,hum,temp,precip)
meta<-phase1.alldata[,c(16,17,18,20,22)]
#subset only the unique lat/longs
metapops<-unique(meta)
#sort by latitude to match the order of the allele frequency files
sort.pops.phase1 <-metapops[order(metapops$latitude),]

## read in lfmm outlier table
lfmm.outlier.table <- read.csv("~/Downloads/vetted.lfmm.temp.env.csv")[,2:3]
#add separate chrom and pos columns
lfmm.outlier.table$chrom<-data.frame(do.call('rbind', strsplit(as.character(lfmm.outlier.table$id),' ',fixed=TRUE)))[,1]
lfmm.outlier.table$pos<-data.frame(do.call('rbind', strsplit(as.character(lfmm.outlier.table$id),' ',fixed=TRUE)))[,2]

## read in bayescan outlier table
bayescan.outlier.table <- read.csv("~/Downloads/vetted.bayescenv.temp.env.csv")[,2:3]
#add separate chrom and pos columns
bayescan.outlier.table$chrom<-data.frame(do.call('rbind', strsplit(as.character(bayescan.outlier.table$id),' ',fixed=TRUE)))[,1]
bayescan.outlier.table$pos<-data.frame(do.call('rbind', strsplit(as.character(bayescan.outlier.table$id),' ',fixed=TRUE)))[,2]

## read in genomic regions and attributes file
genomic_location <- read.gff("~/Downloads/Anopheles_gambiae.AgamP4.47.chr.gff3.gz")
```


```{r}
#keep only regions identified as "gene"
gen_regions <- genomic_location[genomic_location$type == "gene", ] # subset to only gene regions

#pull all genes queried
all.gene.id<-data.frame(do.call('rbind', strsplit(as.character(gen_regions$attributes),';',fixed=TRUE)))[,1]
all.genes<-data.frame(do.call('rbind', strsplit(as.character(all.gene.id),':',fixed=TRUE)))[,2]
#write.table(all.genes, "~/Downloads/all.genes.anopheles.gambiae.txt", row.names = F, col.names = F, quote = F)
```


```{r}
#define chroms
chroms <- c("2R", "2L", "3R", "3L","X") # chromosomes of interest

#initialize gene.list for lfmm
lfmm.gene.list<-data.frame()
#fill gene.list by matching location of genes of interest in gene feature regions by chromosomes
for (i in 1:length(chroms)){
  genloc <- gen_regions[gen_regions$seqid == chroms[i], ] # genome info per chromosome
  pos <- as.numeric(as.character(lfmm.outlier.table[lfmm.outlier.table$chrom == chroms[i],4])) # outlierFST position per chromosome
  for (w in 1:length(pos)) {
    if (nrow(genloc[pos[w] >= genloc$start & pos[w] <= genloc$end,]) !=0){
    lfmm.gene.list<-rbind(lfmm.gene.list, cbind(genloc[pos[w] >= genloc$start & pos[w] <= genloc$end,], pos[w]))
    }
  }
  cat("chromosome", i, "of", length(chroms), "finished\n\n")
}

#pull out gene ID as its own column
lfmm.gene.list$gene.id<-data.frame(do.call('rbind', strsplit(as.character(lfmm.gene.list$attributes),';',fixed=TRUE)))[,1]
lfmm.gene.list$gene<-data.frame(do.call('rbind', strsplit(as.character(lfmm.gene.list$gene.id),':',fixed=TRUE)))[,2]

#make SNP ID column
lfmm.gene.list$SNPid<-paste(lfmm.gene.list$seqid,lfmm.gene.list$`pos[w]`)

#subset
lfmm.gene.list<-lfmm.gene.list[,c("SNPid","gene")]

#number of candidate snps
nrow(lfmm.outlier.table)

#calculate percentage of lfmm candidate SNPs that were in a gene
nrow(lfmm.gene.list)/nrow(lfmm.outlier.table)

#calc % of the genome covered by the genes we are searching
sum(gen_regions$end-gen_regions$start)/278268413 

table(lfmm.gene.list$gene)[table(lfmm.gene.list$gene) >10]
hist(table(lfmm.gene.list$gene))
#write.table(unique(lfmm.gene.list$gene), "~/Downloads/lfmm.temp.gene.list.txt", row.names = F, col.names = F, quote = F)
#write.table(lfmm.gene.list, "~/Downloads/lfmm.temp.gene.snp.match.txt", row.names = F, col.names = T, quote = F)
```

```{r}
#initialize gene.list for bayescan
bayescan.gene.list<-data.frame()
#fill gene.list
for (i in 1:length(chroms)){
  genloc <- gen_regions[gen_regions$seqid == chroms[i], ] # genome info per chromosome
  pos <- as.numeric(as.character(bayescan.outlier.table[bayescan.outlier.table$chrom == chroms[i],4])) # outlierFST position per chromosome
  for (w in 1:length(pos)) {
    if (nrow(genloc[pos[w] >= genloc$start & pos[w] <= genloc$end,]) !=0){
      bayescan.gene.list<-rbind(bayescan.gene.list, cbind(genloc[pos[w] >= genloc$start & pos[w] <= genloc$end,], pos[w]))
    }
  }
  cat("chromosome", i, "of", length(chroms), "finished\n\n")
}

#pull out gene ID as its own column
bayescan.gene.list$gene.id<-data.frame(do.call('rbind', strsplit(as.character(bayescan.gene.list$attributes),';',fixed=TRUE)))[,1]
bayescan.gene.list$gene<-data.frame(do.call('rbind', strsplit(as.character(bayescan.gene.list$gene.id),':',fixed=TRUE)))[,2]

#make SNP ID column
bayescan.gene.list$SNPid<-paste(bayescan.gene.list$seqid,bayescan.gene.list$`pos[w]`)

#subset
bayescan.gene.list<-bayescan.gene.list[,c("SNPid","gene")]

#number of candidate snps
nrow(bayescan.outlier.table)

#calculate percentage of bayescan candidate SNPs that were in a gene
nrow(bayescan.gene.list)/nrow(bayescan.outlier.table)

#calc % of the genome covered by the genes we are searching
sum(gen_regions$end-gen_regions$start)/278268413 

table(bayescan.gene.list$gene)[table(bayescan.gene.list$gene) >10]
hist(table(bayescan.gene.list$gene))

#write.table(unique(bayescan.gene.list$gene), "~/Downloads/bayescan.temp.gene.list.txt", row.names = F, col.names = F, quote = F)
#write.table(bayescan.gene.list, "~/Downloads/bayescan.temp.gene.snp.match.txt", row.names = F, col.names = T, quote = F)
#look into how many genes overlap between the methods
intersect(unique(lfmm.gene.list$gene),unique(bayescan.gene.list$gene))
```

LFMM overrep testing
```{r}
#overrepresentation testing
#read in each GO term to gene map (col1=geneID,col2=GOterm)
mart.export<-read.table("~/Downloads/mart_export (3).txt", sep = "\t", header = T)

#calculate overrepresentation for lfmm temp
lfmm.temp.enriched<-enricher(gene = lfmm.gene.list$gene,
                 universe = all.genes,
                   pAdjustMethod = "fdr",
                 TERM2GENE= mart.export[,c(2,1)]
)
result<-lfmm.temp.enriched@result

lfmm.temp.enriched.sig<-result[result$p.adjust <= .05,]
lfmm.temp.enriched.sig
#write.table(lfmm.temp.enriched.sig[,c("ID","geneID")], file="~/Downloads/lfmm.temp.go.overrep.txt",
#            row.names = F, col.names = F, quote = F)

```

Bayescenv overrep testing
```{r}
#calculate overrepresentation for bayescan temp
bayescan.temp.enriched<-enricher(gene = bayescan.gene.list$gene,
                            universe = all.genes,
                            pAdjustMethod = "fdr",
                            TERM2GENE= mart.export[,c(2,1)]
                            )
result<-bayescan.temp.enriched@result

#retain significantly enriched GO terms
bayescan.temp.enriched.sig<-result[result$p.adjust <= .05,]

#check out significantly overrepresented GO terms
bayescan.temp.enriched.sig
```


```{r}
#get a vector of genes we found SNPs in for each enriched GO term
#lfmm
go.l.0004930<-unlist(strsplit(as.character(lfmm.temp.enriched.sig$geneID[lfmm.temp.enriched.sig$ID == "GO:0004930"]),'/'))
go.l.0007186<-unlist(strsplit(as.character(lfmm.temp.enriched.sig$geneID[lfmm.temp.enriched.sig$ID == "GO:0007186"]),'/'))
#bayescan
go.b.0004930<-unlist(strsplit(as.character(bayescan.temp.enriched.sig$geneID[bayescan.temp.enriched.sig$ID == "GO:0004930"]),'/'))
go.0016055<-unlist(strsplit(as.character(bayescan.temp.enriched.sig$geneID[bayescan.temp.enriched.sig$ID == "GO:0016055"]),'/'))
go.0007275<-unlist(strsplit(as.character(bayescan.temp.enriched.sig$geneID[bayescan.temp.enriched.sig$ID == "GO:0007275"]),'/'))
go.b.0007186<-unlist(strsplit(as.character(bayescan.temp.enriched.sig$geneID[bayescan.temp.enriched.sig$ID == "GO:0007186"]),'/'))
go.0005216<-unlist(strsplit(as.character(bayescan.temp.enriched.sig$geneID[bayescan.temp.enriched.sig$ID == "GO:0005216"]),'/'))
go.0005887<-unlist(strsplit(as.character(bayescan.temp.enriched.sig$geneID[bayescan.temp.enriched.sig$ID == "GO:0005887"]),'/'))
go.0006813<-unlist(strsplit(as.character(bayescan.temp.enriched.sig$geneID[bayescan.temp.enriched.sig$ID == "GO:0006813"]),'/'))
go.0055085<-unlist(strsplit(as.character(bayescan.temp.enriched.sig$geneID[bayescan.temp.enriched.sig$ID == "GO:0055085"]),'/'))
go.0005249<-unlist(strsplit(as.character(bayescan.temp.enriched.sig$geneID[bayescan.temp.enriched.sig$ID == "GO:0005249"]),'/'))
go.0006811<-unlist(strsplit(as.character(bayescan.temp.enriched.sig$geneID[bayescan.temp.enriched.sig$ID == "GO:0006811"]),'/'))
```

#plot all SNPs associated w/ GO:0004930
```{r}
lfmm.gene.list.go.0004930<-lfmm.gene.list[lfmm.gene.list$gene %in% go.l.0004930,]
#plot all SNPs associated w/ GO:0004930
sig.pos<-lfmm.gene.list.go.0004930$SNPid
gene<-droplevels(lfmm.gene.list.go.0004930$gene)
#plot allele freqs vs humidity for these SNPs
par(mfrow=c(3,3))
for (i in 1:length(sig.pos)){
  frq<-as.numeric(as.vector(phase1.all.freqs[phase1.all.freqs$id == sig.pos[i],3:16]))
  plot(sort.pops.phase1$hannual,frq, main = gene[i], ylim = c(0,1), xlab=sig.pos[i])
  abline(lm(frq~sort.pops.phase1$hannual))
}
```

#plot all SNPs associated w/ GO:0007186
```{r}
lfmm.gene.list.go.0007186<-lfmm.gene.list[lfmm.gene.list$gene %in% go.l.0007186,]
#plot all SNPs associated w/ GO:0007186
sig.pos<-lfmm.gene.list.go.0007186$SNPid
gene<-droplevels(lfmm.gene.list.go.0007186$gene)
#plot allele freqs vs humidity for these SNPs
par(mfrow=c(3,3))
for (i in 1:length(sig.pos)){
  frq<-as.numeric(as.vector(phase1.all.freqs[phase1.all.freqs$id == sig.pos[i],3:16]))
  plot(sort.pops.phase1$hannual,frq, main = gene[i], ylim = c(0,1), xlab=sig.pos[i])
  abline(lm(frq~sort.pops.phase1$hannual))
}
```

#plot all SNPs associated w/ GO:0004930
```{r}
bayescan.gene.list.go.0004930<-bayescan.gene.list[bayescan.gene.list$gene %in% go.b.0004930,]
#plot all SNPs associated w/ GO:0004930
sig.pos<-bayescan.gene.list.go.0004930$SNPid
gene<-droplevels(bayescan.gene.list.go.0004930$gene)
#plot allele freqs vs humidity for these SNPs
par(mfrow=c(3,3))
for (i in 1:length(sig.pos)){
  frq<-as.numeric(as.vector(phase1.all.freqs[phase1.all.freqs$id == sig.pos[i],3:16]))
  plot(sort.pops.phase1$hannual,frq, main = gene[i], ylim = c(0,1), xlab=sig.pos[i])
  abline(lm(frq~sort.pops.phase1$hannual))
}
```

#plot all SNPs associated w/ GO:0016055
```{r}
bayescan.gene.list.go.0016055<-bayescan.gene.list[bayescan.gene.list$gene %in% go.0016055,]
#plot all SNPs associated w/ GO:0016055
sig.pos<-bayescan.gene.list.go.0016055$SNPid
gene<-droplevels(bayescan.gene.list.go.0016055$gene)
#plot allele freqs vs humidity for these SNPs
par(mfrow=c(3,3))
for (i in 1:length(sig.pos)){
  frq<-as.numeric(as.vector(phase1.all.freqs[phase1.all.freqs$id == sig.pos[i],3:16]))
  plot(sort.pops.phase1$hannual,frq, main = gene[i], ylim = c(0,1), xlab=sig.pos[i])
  abline(lm(frq~sort.pops.phase1$hannual))
}
```

#plot all SNPs associated w/ GO:0007275
```{r}
bayescan.gene.list.go.0007275<-bayescan.gene.list[bayescan.gene.list$gene %in% go.0007275,]
#plot all SNPs associated w/ GO:0007275
sig.pos<-bayescan.gene.list.go.0007275$SNPid
gene<-droplevels(bayescan.gene.list.go.0007275$gene)
#plot allele freqs vs humidity for these SNPs
par(mfrow=c(3,3))
for (i in 1:length(sig.pos)){
  frq<-as.numeric(as.vector(phase1.all.freqs[phase1.all.freqs$id == sig.pos[i],3:16]))
  plot(sort.pops.phase1$hannual,frq, main = gene[i], ylim = c(0,1), xlab=sig.pos[i])
  abline(lm(frq~sort.pops.phase1$hannual))
}
```

#plot all SNPs associated w/ GO:0007186
```{r}
bayescan.gene.list.go.0007186<-bayescan.gene.list[bayescan.gene.list$gene %in% go.b.0007186,]
#plot all SNPs associated w/ GO:0007186
sig.pos<-bayescan.gene.list.go.0007186$SNPid
gene<-droplevels(bayescan.gene.list.go.0007186$gene)
#plot allele freqs vs humidity for these SNPs
par(mfrow=c(3,3))
for (i in 1:length(sig.pos)){
  frq<-as.numeric(as.vector(phase1.all.freqs[phase1.all.freqs$id == sig.pos[i],3:16]))
  plot(sort.pops.phase1$hannual,frq, main = gene[i], ylim = c(0,1), xlab=sig.pos[i])
  abline(lm(frq~sort.pops.phase1$hannual))
}
```

#plot all SNPs associated w/ GO:0005216
```{r}
bayescan.gene.list.go.0005216<-bayescan.gene.list[bayescan.gene.list$gene %in% go.0005216,]
#plot all SNPs associated w/ GO:0005216
sig.pos<-bayescan.gene.list.go.0005216$SNPid
gene<-droplevels(bayescan.gene.list.go.0005216$gene)
#plot allele freqs vs humidity for these SNPs
par(mfrow=c(3,3))
for (i in 1:length(sig.pos)){
  frq<-as.numeric(as.vector(phase1.all.freqs[phase1.all.freqs$id == sig.pos[i],3:16]))
  plot(sort.pops.phase1$hannual,frq, main = gene[i], ylim = c(0,1), xlab=sig.pos[i])
  abline(lm(frq~sort.pops.phase1$hannual))
}
```

#plot all SNPs associated w/ GO:0005887
```{r}
bayescan.gene.list.go.0005887<-bayescan.gene.list[bayescan.gene.list$gene %in% go.0005887,]
#plot all SNPs associated w/ GO:0005887
sig.pos<-bayescan.gene.list.go.0005887$SNPid
gene<-droplevels(bayescan.gene.list.go.0005887$gene)
#plot allele freqs vs humidity for these SNPs
par(mfrow=c(3,3))
for (i in 1:length(sig.pos)){
  frq<-as.numeric(as.vector(phase1.all.freqs[phase1.all.freqs$id == sig.pos[i],3:16]))
  plot(sort.pops.phase1$hannual,frq, main = gene[i], ylim = c(0,1), xlab=sig.pos[i])
  abline(lm(frq~sort.pops.phase1$hannual))
}
```

#plot all SNPs associated w/ GO:0006813
```{r}
bayescan.gene.list.go.0006813<-bayescan.gene.list[bayescan.gene.list$gene %in% go.0006813,]
#plot all SNPs associated w/ GO:0006813
sig.pos<-bayescan.gene.list.go.0006813$SNPid
gene<-droplevels(bayescan.gene.list.go.0006813$gene)
#plot allele freqs vs humidity for these SNPs
par(mfrow=c(3,3))
for (i in 1:length(sig.pos)){
  frq<-as.numeric(as.vector(phase1.all.freqs[phase1.all.freqs$id == sig.pos[i],3:16]))
  plot(sort.pops.phase1$hannual,frq, main = gene[i], ylim = c(0,1), xlab=sig.pos[i])
  abline(lm(frq~sort.pops.phase1$hannual))
}
```

#plot all SNPs associated w/ GO:0055085
```{r}
bayescan.gene.list.go.0055085<-bayescan.gene.list[bayescan.gene.list$gene %in% go.0055085,]
#plot all SNPs associated w/ GO:0055085
sig.pos<-bayescan.gene.list.go.0055085$SNPid
gene<-droplevels(bayescan.gene.list.go.0055085$gene)
#plot allele freqs vs humidity for these SNPs
par(mfrow=c(3,3))
for (i in 1:length(sig.pos)){
  frq<-as.numeric(as.vector(phase1.all.freqs[phase1.all.freqs$id == sig.pos[i],3:16]))
  plot(sort.pops.phase1$hannual,frq, main = gene[i], ylim = c(0,1), xlab=sig.pos[i])
  abline(lm(frq~sort.pops.phase1$hannual))
}
```

#plot all SNPs associated w/ GO:0005249
```{r}
bayescan.gene.list.go.0005249<-bayescan.gene.list[bayescan.gene.list$gene %in% go.0005249,]
#plot all SNPs associated w/ GO:0005249
sig.pos<-bayescan.gene.list.go.0005249$SNPid
gene<-droplevels(bayescan.gene.list.go.0005249$gene)
#plot allele freqs vs humidity for these SNPs
par(mfrow=c(3,3))
for (i in 1:length(sig.pos)){
  frq<-as.numeric(as.vector(phase1.all.freqs[phase1.all.freqs$id == sig.pos[i],3:16]))
  plot(sort.pops.phase1$hannual,frq, main = gene[i], ylim = c(0,1), xlab=sig.pos[i])
  abline(lm(frq~sort.pops.phase1$hannual))
}
```

#plot all SNPs associated w/ GO:0006811
```{r}
bayescan.gene.list.go.0006811<-bayescan.gene.list[bayescan.gene.list$gene %in% go.0006811,]
#plot all SNPs associated w/ GO:0006811
sig.pos<-bayescan.gene.list.go.0006811$SNPid
gene<-droplevels(bayescan.gene.list.go.0006811$gene)
#plot allele freqs vs humidity for these SNPs
par(mfrow=c(3,3))
for (i in 1:length(sig.pos)){
  frq<-as.numeric(as.vector(phase1.all.freqs[phase1.all.freqs$id == sig.pos[i],3:16]))
  plot(sort.pops.phase1$hannual,frq, main = gene[i], ylim = c(0,1), xlab=sig.pos[i])
  abline(lm(frq~sort.pops.phase1$hannual))
}
```


#Best places to find info:
#uniprot database:
#uniprot.org/
#UC Irvine AGAM Gene Expression Profile
#http://www.angagepuci.bio.uci.edu/
#AG1000G selection atlas
#https://malariagen.github.io/agam-selection-atlas/0.1-alpha3/index.html


